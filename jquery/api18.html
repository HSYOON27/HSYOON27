<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/load.css">
    <link rel="stylesheet" type="text/css" href="/css/reset.css">
    <link rel="stylesheet" type="text/css" href="/css/commons.css">
    <link rel="stylesheet" type="text/css" href="/css/layout.css">
    <link rel="stylesheet" type="text/css" href="/css/test.css">
    <style>
        .map {
            width: 100%;
            min-height: 300px; /* 50vh 모바일에서 주로 사용*/
        }
        .info-window .text{
            display: block;
        }
    </style>

    <!-- jquery cdn -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- kakao map cdn-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8e94356a77b43b5252dffe637ce87e08&libraries=services"></script>

    <script type="text/template" id="info-window-template">
        <div class="info-window p-10">
            <span class="text">{{text}}</span>
            <a class="link" href="{{link}}">{{linkText}}</a>
        </div>
    </script>

    <script type="text/javascript">
        $(function(){
            //생성한 마커를 저장할 배열을 만들어야함. 왜? 나중에 지워야 되니까.
            var memory = []; //마커 저장소
            var memory2 = []; //인포윈도우 저장소 

            // [1] 지도 생성
            createMap();

            // [2] 주소 입력창에 blur 이벤트 처리
            $("[name=address]").blur(function(){
                clearMarker();

                var address = $(this).val();
                if(address.trim().length == 0) return;

                // 주소-좌표 변환 객체를 생성합니다
                var geocoder = new kakao.maps.services.Geocoder();

                // 검색
                geocoder.addressSearch(address, function(result, status) {
                    // 정상적으로 검색이 완료됐으면 
                    if (status === kakao.maps.services.Status.OK) {
                        var lat = result[0].y;
                        var lng = result[0].x;

                        moveMap(lat, lng);
                        // createMarker(lat, lng);
                        createMarkerWithText(lat, lng, address, '#', '');


                    }
                    else{ // 정상적으로 검색이 이루어지지 않았다면
                        window.alert("검색결과가 없습니다")
                    }
                });
            });

            // 지도 생성 함수
            function createMap() {
                var container = document.querySelector(".map");
                // var container = $(".map").get(0);
                var options = {
                    center: new kakao.maps.LatLng(37.5552, 126.9706),
                    level: 3
                };
                
                // 최상위 객체인 window에 추가해서 아무데서나 사용 가능하도록 처리
                // 장점 - 호출이 편하다
                // 단점 - 충돌 가능성이 있음
                window.map = new kakao.maps.Map(container, options);
            }

            // 지도 이동 함수
            function moveMap(lat, lng){
                // 이동할 위도 경도 위치를 생성합니다 
                var moveLatLon = new kakao.maps.LatLng(lat, lng);

                // 지도 중심을 이동 시킵니다
                map.setCenter(moveLatLon);
            }
            
            //  마커 생성 함수
            function createMarker(lat, lng) {
                        // 마커가 표시될 위치입니다 
                        var markerPosition  = new kakao.maps.LatLng(lat, lng); 

                        // 마커를 생성합니다
                        var marker = new kakao.maps.Marker({
                            position: markerPosition
                        });

                        // 마커가 지도 위에 표시되도록 설정합니다
                        marker.setMap(map);

                        // 아래 코드는 지도 위의 마커를 제거하는 코드입니다
                        // marker.setMap(null);   
                        
                        //마커 이력 추가
                        memory.push(marker);
            }


                        // 마커 + 인포윈도우 생성 함수
                        function createMarkerWithText(lat, lng, text, link, linkText) {
                
                        // 마커가 표시될 위치입니다 
                        var markerPosition  = new kakao.maps.LatLng(lat, lng); 

                        // 마커를 생성합니다
                        var marker = new kakao.maps.Marker({
                            position: markerPosition
                        });

                        // 마커가 지도 위에 표시되도록 설정합니다
                        marker.setMap(map);

                        // 아래 코드는 지도 위의 마커를 제거하는 코드입니다
                        // marker.setMap(null);   

                        // 인포윈도우 코드
                        // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
                        // var iwContent = '<div style="padding:5px;"></div>';
                        var template = $("#info-window-template").html();
                        template = template.replace("{{text}}", text);
                        template = template.replace("{{link}}", link);
                        template = template.replace("{{linkText}}", linkText);
                        var iwContent = template;
                        var iwPosition = new kakao.maps.LatLng(lat, lng); //인포윈도우 표시 위치입니다
                    

                        // 인포윈도우를 생성합니다
                        var infowindow = new kakao.maps.InfoWindow({
                            position : iwPosition, 
                            content : iwContent 
                        });

                        
                        
                        // 마커 위에 인포윈도우를 표시합니다. 두번째 파라미터인 marker를 넣어주지 않으면 지도 위에 표시됩니다
                        infowindow.open(map, marker); 

                        //마커와 인포윈도우 이력 추가
                        memory.push(marker);
                        memory2.push(infowindow);
                }
                //모든 마커와 인포 윈도우를 삭제 를 삭제
                function clearMarker(){
                    for(var i=0; i < memory.length; i++){
                        memory[i].setMap(null);
                    }
                    for(var i=0; i < memory2.length; i++){
                        memory2[i].setMap(null);
                    }
                    memory = [];
                    memory2 = [];
                }
        });
    </script>
</head>
<body>
    <div class="container-600">
        <div class="row center">
            <h1>주소로 지도찾기</h1>
        </div>
        <div class="row">
            <input type="text" name="address" class="form-input w-100"
                            placeholder="주소 입력">
        </div>
        <div class="row">
            <div class="map"></div>
        </div>
        
    </div>
</body>
</html>